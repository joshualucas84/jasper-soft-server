define(["require","backbone","underscore","components.list","dataSource/view/SubDataSourceItemView","common/util/featureDetection","text!dataSource/template/subDataSourcesListTemplate.htm","utils.common"],function(e){"use strict";var t=e("backbone"),i=e("underscore"),s=e("components.list"),n=e("dataSource/view/SubDataSourceItemView"),o=e("common/util/featureDetection"),u=e("text!dataSource/template/subDataSourcesListTemplate.htm");return e("utils.common"),t.View.extend({events:{"blur input.dataSourceID":"disableSelection","focus input.dataSourceID":"enableSelection"},initialize:function(e){this.options=e,this.subviews=[],this._list=new s.UnderscoreTemplatedList("selectedSubDataSourcesList",{template:u,dragPattern:"",multiSelect:!0,selectOnMousedown:!o.supportsTouch}),this._list.observe("item:unselected",i.bind(this._itemUnselected,this)),this._list.observe("item:selected",i.bind(this._itemSelected,this)),this.setElement("#selectedSubDataSourcesList",!1),this.listenTo(this.collection,"reset",this.render)},disableSelection:function(){disableSelectionWithoutCursorStyle(this._list._getElement())},enableSelection:function(){enableSelection(this._list._getElement())},_itemUnselected:function(e){var t=this.getSubviewByListItem(e.memo.item),i=t?t.model:null;this.trigger("item:unselected",i)},_itemSelected:function(e){var t=this.getSubviewByListItem(e.memo.item),i=t?t.model:null;this.trigger("item:selected",i)},render:function(e,t){this._list.resetSelected();var s=[],n=[],o=[],u=!1,r=this.collection.map(function(e){return e.get("uri")}),c=this;if(t&&t.previousModels&&(o=i.map(t.previousModels,function(e){return e.get("uri")}),i.each(t.previousModels,function(e){i.include(r,e.get("uri"))||n.push(e)}),u=!0),this.collection.forEach(function(e){i.include(o,e.get("uri"))||s.push(e)}),s.length&&(i.each(s,function(e){c.addSubview(e)}),this._list.show(),u)){var l=i.compact(i.map(s,i.bind(c.getSubviewByModel,c)));i.each(l,function(e){c._list.selectItem(e.getListItem(),!0)})}return n.length&&(i.each(n,function(e){c.removeSubview(e)}),this._list.show()),this},getSubviewByModel:function(e){return i.find(this.subviews,function(t){return t.model===e})},getList:function(){return this._list},getListLength:function(){return this._list._items.length},getSelectedModels:function(){var e=this._list.getSelectedItems(),t=i.compact(i.map(e,i.bind(this.getSubviewByListItem,this)));return i.map(t,function(e){return e.model})},getSubviewByListItem:function(e){return i.find(this.subviews,function(t){return t.getListItem()===e})},removeSubview:function(e){var t=this.getSubviewByModel(e);t&&(this._list.removeItems([t.getListItem()]),t.remove(),this._list.show())},addSubview:function(e){var t=new n({model:e});this.subviews.push(t),this._list.addItems([t.getListItem()]),this._list.show(),i.defer(i.bind(t.setRootElement,t))},removeSubviews:function(){var e=i.map(this.subviews,function(e){return e.getListItem()});this._list.removeItems(e),i.invoke(this.subviews,"remove")},remove:function(){this.removeSubviews(),t.View.prototype.remove.apply(this,arguments)}})});