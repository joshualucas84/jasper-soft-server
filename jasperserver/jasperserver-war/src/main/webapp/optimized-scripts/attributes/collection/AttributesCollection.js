define(["require","underscore","jquery","json3","backbone","request","components.templateengine","serverSettingsCommon/enum/serverSettingGroupsEnum","attributes/enum/levelIdEnum"],function(e){var t=e("underscore"),n=e("jquery"),r=e("json3"),i=e("backbone"),a=e("request"),s=e("components.templateengine"),o=e("serverSettingsCommon/enum/serverSettingGroupsEnum"),u=e("attributes/enum/levelIdEnum"),c={TENANT:"tenant:/",USER:"user:/"},l=i.Collection.extend({initialize:function(e,t){t=t||{};var n="rest_v2/attributes?_embedded=permission",r=n+"&group="+o.CUSTOM,i=t.context||{};this.urlGETTemplate=i.urlGETTemplate||r,this.urlPUTTemplate=i.urlPUTTemplate||n},parse:function(e){return e&&e.attribute?e.attribute:[]},setContext:function(e){e=e||{urlGETTemplate:this.urlGETTemplate,urlPUTTemplate:this.urlPUTTemplate};var r=new n.Deferred;return t.isEqual(this.context,e)?r.resolve():(this.context=e,this.fetch({reset:!0,headers:{Accept:"application/attributes.collection.hal+json"}}).done(r.resolve)),r},getContext:function(){return this.context},url:function(e){var n=t.extend({},this.context),r="PUT"===e?this.urlPUTTemplate:this.urlGETTemplate;return t.each(u,function(e){n[e]&&(n[e]=this.escapeLevelId(n[e]))},this),s.renderUrl(r,n,!1)},escapeLevelId:function(e){return encodeURIComponent(e).replace(/'/g,"%27")},save:function(e,t){var n="PUT",i=this._modelsToJSON(t,!0),s="application/hal+json";return a({url:this.url(n)+this._concatNames(e),type:"PUT",contentType:s,headers:{Accept:s},data:r.stringify({attribute:i})})},validateSearch:function(e,n,r,i){var a="&recursive=true",s=i&&this._concatGroups();return this.search(e,n,a,r,s).done(t.bind(this._successSearchCallback,this,e,n))},filterInheritedAttributes:function(e){var n=e&&e.attribute;return e?t.filter(n,function(e){return e.inherited&&!this.findWhere({name:e.name,inherited:!0})},this):null},search:function(e,t,n,r,i){n=n||"",i=i||"";var s="application/attributes.collection.hal+json";return a({url:this.url()+this._concatNames(e,r)+n+i,type:"GET",dataType:"json",contentType:s,headers:{Accept:s}})},getHolder:function(){return this.context.id?c.TENANT+this.context.id:this.context.tenantId?c.USER+this.context.tenantId+"/"+this.context.userName:c.TENANT},addItemsToCollection:function(e){!t.isArray(e)&&(e=[e]),t.each(e,function(e){this.addNew(e)},this)},addNew:function(e){e=e||{};var t=new this.model(e);return this.add(t),t},_modelsToJSON:function(e,n){return t.map(e,function(e){return e.toJSON({omitValue:n})})},_successSearchCallback:function(e,n,r){e=t.isArray(e)?e:[e],n=this._modelsToJSON(n);var i,a,s=this.getHolder();t.each(e,function(e){a=s?s:e.holder,e.holder=a,r&&r.attribute.length&&(e.attr=r.attribute),n&&t.where(n,{name:e.get("name"),inherited:!1}).length>1&&(i={holder:a},e.attr?e.attr.push(i):e.attr=[i])},this)},_concatGroups:function(){var e="";return t.each(t.omit(o,"CUSTOM"),function(t){e+="&group="+t}),e},_concatNames:function(e,n){e=t.isArray(e)?e:[e];var r,i="",a=this,s=function(e){return"&name="+a.escapeLevelId(e)};return t.each(e,function(e){r=e.get("id"),!n&&e.isRenamed()&&r&&(i+=s(r)),i+=s(e.get("name"))},this),i}});return l});